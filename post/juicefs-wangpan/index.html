<html>

<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>
    基于JuiceFS搭建个人网盘 | voidint
</title>
<link rel="shortcut icon" href="https://voidint.github.io/favicon.ico?v=1615287957774">
<!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous"> -->
<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://voidint.github.io/styles/main.css">
<!-- js -->
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://voidint.github.io/media/js/jquery.sticky-sidebar.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.23.0/moment.min.js"></script>


        
</head>

<body>
    <div class="main">
        <div class="header">
    <div class="nav">
        <div class="logo">
            <a href="https://voidint.github.io">
                <img class="avatar" src="https://voidint.github.io/images/avatar.png?v=1615287957774" alt="">
            </a>
            <div class="site-title">
                <h1>
                    voidint
                </h1>
            </div>
        </div>
        <span class="menu-btn fa fa-align-justify"></span>
        <div class="menu-container">
            <ul>
                
                    
                            <li>
                                <a href="/" class="menu">
                                    首页
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/archives" class="menu">
                                    归档
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/tags" class="menu">
                                    标签
                                </a>
                            </li>
                            
                                
                    
                        <li>
                            <a href="https://github.com/voidint" class="menu" target="_blank">
                                关于
                            </a>
                        </li>
                        
                                
            </ul>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $(".menu-btn").click(function() {
            $(".menu-container").slideToggle();
        });
        $(window).resize(function() {

            if (window.matchMedia('(min-width: 960px)').matches) {
                $(".menu-container").css('display', 'block')
            } else {
                $(".menu-container").css('display', 'none')
            }

        });
    });
</script>

            <div id="main-content" class="post-detail main-container">
                <!-- left -->
                <div id="content" class="main-container-left">
                    <article class="post i-card">
                        <h2 class="post-title">
                            基于JuiceFS搭建个人网盘
                        </h2>
                        <div class="post-info">
                            <time class="post-time">2021-03-09</time>
                            
                                <a href="https://voidint.github.io/tag/OnCZ3Bu4o/" class="post-tag i-tag
                            i-tag-error">
                            #JuiceFS
                        </a>
                                
                                <a href="https://voidint.github.io/tag/d57-jY5Of3/" class="post-tag i-tag
                            i-tag-other_3">
                            #分布式文件系统
                        </a>
                                
                                <a href="https://voidint.github.io/tag/FtS8XK8u_9/" class="post-tag i-tag
                            i-tag-other_3">
                            #网盘
                        </a>
                                
                        </div>
                        
                            <div class="post-feature-image" style="background-image: url('https://voidint.github.io/post-images/juicefs-wangpan.png')"></div>
                            
                                <div class="post-content">
                                    <h1 id="什么是juicefs">什么是JuiceFS</h1>
<blockquote>
<p>JuiceFS 是为云端设计的共享文件系统。<br>
云端：采用云服务中的对象存储作为后端，综合性价比极高。<br>
共享：上千台机器同时挂载，高性能并发读写，共享数据。<br>
易用：POSIX、HDFS、NFS 兼容，无门槛对接现有应用。</p>
</blockquote>
<p>以上是<a href="https://juicefs.com/">JuiceFS</a>的官方定义。简单来说，JuiceFS就是一个基于对象存储的分布式文件系统。</p>
<figure data-type="image" tabindex="1"><img src="https://voidint.github.io/post-images/1615287684809.png" alt="" loading="lazy"></figure>
<h1 id="目标">目标</h1>
<p>基于JuiceFS搭建一个存储在阿里云OSS之上的个人网盘。主机A、B上挂载该网盘后，能做到互通有无，即可读可写。</p>
<h1 id="前期准备">前期准备</h1>
<p>1、申请一个阿里云账号，将AccessKey ID导出到环境变量<code>ACCESS_KEY</code>，将AccessKey Secret导出到环境变量<code>SECRET_KEY</code>。<br>
2、购买阿里云OSS服务并创建bucket。bucket的名字暂时定为<code>voidint</code>。<br>
3、准备两台主机。此次实验我准备了一台公有云上的虚拟机以及一台MacBook Pro。<br>
4、准备一台Redis服务器，且以上的两台主机均可以访问此Redis服务。本次实验中我将Redis服务部署在了公有云虚拟机之上。<br>
5、为Redis设置一个强密码并导出到环境变量<code>REDIS_PASSWORD</code>。</p>
<h1 id="搭建过程">搭建过程</h1>
<h2 id="构建juicefs二进制程序">构建juicefs二进制程序</h2>
<pre><code class="language-shell">
$ git clone https://github.com/juicedata/juicefs.git
$ cd juicefs 
$ make
</code></pre>
<p>建议使用源代码构建，千万不要按照<a href="https://juicefs.com/docs/zh/getting_started.html">上手指南</a>中所说通过<code>curl</code>下载juicefs。也许是文档未及时更新，官方文档上所描述的均为Python缩写的juicefs客户端程序，而<strong>本次实验所用到的是go语言所编写的juicefs客户端程序</strong>。</p>
<h2 id="格式化网盘">格式化网盘</h2>
<pre><code class="language-shell">
$ juicefs help format
NAME:
   juicefs format - format a volume

USAGE:
   juicefs format [command options] REDIS-URL NAME

OPTIONS:
   --block-size value       size of block in KiB (default: 4096)
   --compress value         compression algorithm (lz4, zstd, none) (default: &quot;lz4&quot;)
   --storage value          Object storage type (e.g. s3, gcs, oss, cos) (default: &quot;file&quot;)
   --bucket value           A bucket URL to store data (default: &quot;/Users/voidint/.juicefs/local&quot;)
   --access-key value       Access key for object storage (env ACCESS_KEY)
   --secret-key value       Secret key for object storage (env SECRET_KEY)
   --encrypt-rsa-key value  A path to RSA private key (PEM)
   --force                  overwrite existing format (default: false)
</code></pre>
<p>格式化的命令及选项如上所示，需要关注的选项分别为<code>--storage</code>和<code>--bucket</code>。由于本次实验使用的是阿里云OSS，因此将storage选项设置为<code>oss</code>。按照<a href="https://github.com/juicedata/juicefs/blob/main/docs/en/how_to_setup_object_storage.md#alibaba-cloud-object-storage-service">文档</a>所述，将bucket选项值设置为<code>https://voidint</code>。</p>
<p>另外，由于阿里云的操作凭证信息已经导出到了<code>ACCESS_KEY</code>和<code>SECRET_KEY</code>这两个环境变量，因此无需再重复设置format子命令中相关的选项值。</p>
<p>由于网盘中的文件元数据会被存储到Redis，还需要指定一个Redis的URL（<a href="https://pkg.go.dev/github.com/go-redis/redis#ParseURL">格式</a>），这里指定公有云上主机的IP地址，如<code>113.31.11.123</code>。</p>
<p>还需要给网盘取一个显示的名字，如<code>alicloud</code>（此处暂不支持中文字符）。</p>
<pre><code class="language-shell">
# 两台主机上分别执行以下命令：
$ ./juicefs format --storage oss --bucket http://voidint 113.31.11.123 alicloud
</code></pre>
<h2 id="挂载网盘">挂载网盘</h2>
<pre><code class="language-shell">
$ juicefs help mount
NAME:
   juicefs mount - mount a volume

USAGE:
   juicefs mount [command options] REDIS-URL MOUNTPOINT

OPTIONS:
   --metrics value           address to export metrics (default: &quot;:9567&quot;)
   --no-usage-report         do not send usage report (default: false)
   -d, --background          run in background (default: false)
   --no-syslog               disable syslog (default: false)
   -o value                  other FUSE options
   --attr-cache value        attributes cache timeout in seconds (default: 1)
   --entry-cache value       file entry cache timeout in seconds (default: 1)
   --dir-entry-cache value   dir entry cache timeout in seconds (default: 1)
   --enable-xattr            enable extended attributes (xattr) (default: false)
   --get-timeout value       the max number of seconds to download an object (default: 60)
   --put-timeout value       the max number of seconds to upload an object (default: 60)
   --io-retries value        number of retries after network failure (default: 30)
   --max-uploads value       number of connections to upload (default: 20)
   --buffer-size value       total read/write buffering in MB (default: 300)
   --prefetch value          prefetch N blocks in parallel (default: 3)
   --writeback               upload objects in background (default: false)
   --cache-dir value         directory paths of local cache, use colon to separate multiple paths (default: &quot;/Users/voidint/.juicefs/cache&quot;)
   --cache-size value        size of cached objects in MiB (default: 1024)
   --free-space-ratio value  min free space (ratio) (default: 0.1)
   --cache-partial-only      cache only random/small read (default: false)
</code></pre>
<p>挂载命令需要设置的选项和参数很少，<code>-d</code>可以使其以守护进程方式运行，<code>REDIS-URL</code>参数用于指定Redis服务地址，<code>MOUNTPOINT</code>用于指定目录挂载点。</p>
<pre><code class="language-shell">
# 两台主机上分别执行以下命令：
$ ./juicefs mount -d 113.31.11.123 ~/jfs
</code></pre>
<h2 id="测试网盘读写">测试网盘读写</h2>
<p>在等待挂载完毕后，便可以开始对网盘进行读写测试。</p>
<pre><code class="language-shell"># 两台主机上分别执行以下命令：
$ echo $(hostname) &gt;&gt; ~/jfs/hostname.txt
$ cat ~/jfs/hostname.txt
voidint
113-31-11-123
</code></pre>
<p>从输出可知，两台主机已经挂载了同一块网盘。</p>
<h2 id="卸载网盘">卸载网盘</h2>
<pre><code class="language-shell">
$ juicefs help umount
NAME:
   juicefs umount - unmount a volume

USAGE:
   juicefs umount [command options] MOUNTPOINT

OPTIONS:
   --force, -f  unmount a busy mount point by force (default: false)
</code></pre>
<p>卸载网盘的方式也极为简单，只需要指定挂载目录即可。</p>
<pre><code class="language-shell">
# 两台主机上分别执行以下命令：
$ j umount ~/jfs
</code></pre>
<h2 id="再次挂载网盘">再次挂载网盘</h2>
<p>为了验证卸载后重新挂载依然能够读写之前的文件，下面重新挂载该网盘。</p>
<pre><code class="language-shell">
# 两台主机上分别执行以下命令：
$ ./juicefs mount -d 113.31.11.123 ~/jfs
$ ls -lh ~/jfs
-rw-r--r--  1 voidint  staff    21B  3  9 18:47 hostname.txt
</code></pre>
<p>可以看到hostname.txt文件依然还存在。大功告成！</p>
<h1 id="参考">参考</h1>
<ul>
<li><a href="https://juicefs.com/docs/zh/intro.html">JuiceFS文档</a></li>
<li><a href="https://github.com/juicedata/juicefs">JuiceFS GitHub</a></li>
</ul>

                                </div>
                    </article>
                    <!--  -->
                    
                        <div class="next-post">
                            <div class="next">下一篇</div>
                            <a href="https://voidint.github.io/post/goproxyio-installation/">
                                <h3 class="post-title">
                                    goproxy.io内部私有化部署
                                </h3>
                            </a>
                        </div>
                        
                            <div id="disqus_thread"></div>
                            <div id="gitalk-container"></div>
                </div>
                <!-- middle -->
                <div class="main-container-middle"></div>
                <!-- right -->
                <div id="sidebar" class="main-container-right">
                    
                        <!-- toc -->
                        
    <div class="toc-card i-card ">
        <div class="toc-title i-card-title">目录</div>
        <div class="toc-content">
            <ul class="markdownIt-TOC">
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AFjuicefs">什么是JuiceFS</a></li>
<li><a href="#%E7%9B%AE%E6%A0%87">目标</a></li>
<li><a href="#%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87">前期准备</a></li>
<li><a href="#%E6%90%AD%E5%BB%BA%E8%BF%87%E7%A8%8B">搭建过程</a>
<ul>
<li><a href="#%E6%9E%84%E5%BB%BAjuicefs%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%A8%8B%E5%BA%8F">构建juicefs二进制程序</a></li>
<li><a href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E7%BD%91%E7%9B%98">格式化网盘</a></li>
<li><a href="#%E6%8C%82%E8%BD%BD%E7%BD%91%E7%9B%98">挂载网盘</a></li>
<li><a href="#%E6%B5%8B%E8%AF%95%E7%BD%91%E7%9B%98%E8%AF%BB%E5%86%99">测试网盘读写</a></li>
<li><a href="#%E5%8D%B8%E8%BD%BD%E7%BD%91%E7%9B%98">卸载网盘</a></li>
<li><a href="#%E5%86%8D%E6%AC%A1%E6%8C%82%E8%BD%BD%E7%BD%91%E7%9B%98">再次挂载网盘</a></li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83">参考</a></li>
</ul>

        </div>
        <script>
            function locateCatelogList() {
                /*获取文章目录集合,可通过:header过滤器*/
                var alis = $('.post-content :header');
                /*获取侧边栏目录列表集合**/
                var sidebar_alis = $('.markdownIt-TOC a');
                /*获取滚动条到顶部的距离*/
                var scroll_height = $(window).scrollTop();
                for (var i = 0; i < alis.length; i++) {
                    /*获取锚点集合中的元素分别到顶点的距离*/
                    var a_height = $(alis[i]).offset().top;
                    if (a_height < scroll_height) {
                        /*高亮显示*/
                        sidebar_alis.removeClass('on');
                        $(sidebar_alis[i]).addClass('on');
                    }
                }
            }
            $(function() {
                /*绑定滚动事件 */
                $(window).bind('scroll', locateCatelogList);
            });
        </script>
    </div>
    
                            

                </div>




            </div>


            <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | 
  <a class="rss" href="https://voidint.github.io/atom.xml" target="_blank">RSS</a>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>


    </div>
    <script>
        $('#sidebar').stickySidebar({
            topSpacing: 80,
            // bottomSpacing: 60
        });
    </script>
    
</body>

</html>